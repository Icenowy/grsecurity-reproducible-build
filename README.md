# Grsecurity Reproducible build scripts

These scripts are intended to do reproducible build for Linux kernel with Grsecurity patch set.

## Dependencies

The kernel building script will need the standard kernel building dependencies to be install.

### Debian-derived distributions

Use the command below to install the dependencies needed.

```
sudo apt-get install build-essential bc flex bison
```

## Usage

To build the kernel deterministically, a certain kernel build directory is necessary. Currently /kbuild is chosen to be the fixed directory. So you should at first create it and grant rwx permission of the directory for the UNIX user you used to build the kernel.

As a directory under /, root access will be needed to create this directory.

```
sudo mkdir /kbuild
# Assume we're using the kernelbuild user
sudo chown kernelbuild /kbuild
```

After preparing the directory, you can place a kernel config file named "config" in this directory, and then just run "run.sh".

Some kernel configs modified to enable PaX and being deterministic is placed under configs/, include:

- configs/paxed-allnoconfig: an all-no config with PaX and module support enabled, only for testing purpose.

- configs/paxed-defconfig: defconfig with PaX enabled, can be used as a basis to customify the config.

- configs/paxed-mint-config: a config file from Linux Mint 18 with PaX enabled, can be directly used on Debian-derived distributions without modification.

If you do not have the necessary GPG public key imported to verify the signature of GNU things and the Linux Kernel, you can set VERIFY_GPG environment variable to 0, thus signature verifying will be disabled.

Then the output kernel (bzImage, vmlinux, modules, DPKG packages and build fingerprint) is located at out/

## DPKG packages notice

Currently, we cannot ensure DPKG packages to be reproducible. However, we can promise the content of all the packages are reproducible.

A shell script named "deb-diff.sh" is present to compare the content of two DPKG packages. It will simply extract files from the package, and then use "diff" command to check the difference of them.

## Config options to be noted

### CONFIG_MODULE_SIG (Module signature verification)

When this option is enabled, there will be a key embedded into the kernel, which is used to sign modules.

The key is either generated at build time (from /dev/random, which made the key not reproducible), or pre-generated (which made the signing system useless, as the key-pair will be provided to anyone who wants to verify the build).

Although support for pre-generated key-pair can be implemented, it's not implemented now.

So the option should be *DISABLED* now.

**TODO**: support for external pre-generated key-pair.

### CONFIG_PAX_LATENT_ENTROPY (Generate some entropy during boot and runtime)

When this option is enabled, the generated binary code will contain some random bits generated by GCC at build time, as entropy.

Enabling this option will lead to irreproducible builds.

So the option should be *DISABLED* now.

### CONFIG_GRKERNSEC_RANDSTRUCT (Randomize layout of sensitive kernel structures)

When this option is enabled, the generated binary will have sensitive kernel structures randomized.

It uses a seed from /dev/urandom at build time, however, currently the scripts have already hacked the seed generation process. Now the seed is part of the build fingerprint.

So the option is now *safe to ENABLE*.

### CONFIG_CC_STACKPROTECTOR\* (Stack Protector buffer overflow detection)

When this option is set to "Regular" or "Strong", some stack-overflow check code will be inserted.

As this option needs a compiler with SSP support (The temporary toolchain built by build-toolchain.sh do not support SSP), this feature cannot be enabled.

So the option should be *NONE* now.
